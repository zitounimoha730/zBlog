<h1>Apache Kafka â€“ Delete Topics & Compaction Topics</h1>

<h2>ğŸ—‘ï¸ Delete Topics (Log Retention par suppression)</h2>

<p>
Dans Kafka, un <strong>topic â€œdeleteâ€</strong> (comportement par dÃ©faut) supprime les messages
<strong>anciens</strong> selon des rÃ¨gles de rÃ©tention.
</p>

<h3>ğŸ”¹ RÃ©tention par taille</h3>
<ul>
    <li>Chaque <strong>partition</strong> dâ€™un topic peut avoir une taille maximale (<code>retention.bytes</code>)</li>
    <li>Exemple : <code>retention.bytes = 20 KB</code></li>
    <li>Lorsque la taille est dÃ©passÃ©e :
        <ul>
            <li>Kafka supprime les <strong>segments les plus anciens</strong></li>
            <li>Les messages rÃ©cents sont conservÃ©s</li>
        </ul>
    </li>
    <li>Par dÃ©faut : <strong>pas de limite de taille</strong> (<code>-1</code>)</li>
</ul>

<div class="note">
    ğŸ‘‰ La suppression se fait <strong>par segments de log</strong>, pas message par message.
</div>

<h3>ğŸ”¹ RÃ©tention par temps</h3>
<ul>
    <li>Chaque topic peut dÃ©finir une durÃ©e de rÃ©tention (<code>retention.ms</code>)</li>
    <li>Exemple : <code>retention.ms = 1 jour</code></li>
    <li>AprÃ¨s cette durÃ©e :
        <ul>
            <li>Les messages deviennent <strong>Ã©ligibles Ã  la suppression</strong></li>
            <li>Kafka supprime les segments trop anciens</li>
        </ul>
    </li>
    <li>Par dÃ©faut : <code>retention.ms = 7 jours</code></li>
</ul>

<h3>ğŸ”¹ CaractÃ©ristiques importantes</h3>
<ul>
    <li>Kafka ne supprime pas les messages immÃ©diatement</li>
    <li>Un processus interne (log cleaner) sâ€™exÃ©cute pÃ©riodiquement</li>
    <li>La suppression est <strong>indÃ©pendante des consumers</strong></li>
</ul>

<h3>ğŸ§  Cas dâ€™usage</h3>
<ul>
    <li>Logs applicatifs</li>
    <li>Events mÃ©tier</li>
    <li>DonnÃ©es temporelles (tracking, mÃ©triques, historiques)</li>
</ul>

<hr>

<h2>â™»ï¸ Compaction Topics (Log Compaction)</h2>

<p>
Un <strong>topic compactÃ©</strong> conserve uniquement la
<strong>derniÃ¨re valeur associÃ©e Ã  chaque clÃ©</strong>.
</p>

<h3>ğŸ”¹ Principe</h3>
<ul>
    <li>Kafka ne modifie jamais un message existant</li>
    <li>Chaque nouveau message est <strong>ajoutÃ© au log</strong></li>
    <li>Les anciennes versions sont supprimÃ©es plus tard</li>
</ul>

<div class="note">
    âŒ Kafka ne â€œmet pas Ã  jourâ€ un message<br>
    âœ… Kafka ajoute un nouveau message puis supprime lâ€™ancien lors du nettoyage
</div>

<h3>ğŸ”¹ Fonctionnement dÃ©taillÃ©</h3>
<ul>
    <li>Chaque message doit avoir une <strong>clÃ© non nulle</strong></li>
    <li>Le log cleaner :
        <ul>
            <li>Parcourt les segments</li>
            <li>Conserve la <strong>derniÃ¨re version par clÃ©</strong></li>
            <li>Supprime les anciennes versions</li>
        </ul>
    </li>
</ul>

<h3>ğŸ”¹ Messages avec valeur <code>null</code></h3>
<pre>
key = X
value = null
</pre>
<ul>
    <li>ReprÃ©sente une <strong>suppression logique</strong> (tombstone)</li>
    <li>AprÃ¨s un dÃ©lai, la clÃ© est supprimÃ©e dÃ©finitivement</li>
</ul>

<h3>ğŸ”¹ ParamÃ¨tres clÃ©s</h3>
<ul>
    <li><code>cleanup.policy=compact</code></li>
    <li><code>min.compaction.lag.ms</code></li>
    <li><code>delete.retention.ms</code></li>
</ul>

<h3>ğŸ§  Cas dâ€™usage</h3>
<ul>
    <li>Tables de rÃ©fÃ©rence</li>
    <li>Ã‰tat courant dâ€™un systÃ¨me</li>
    <li>Configuration distribuÃ©e</li>
    <li>Event Sourcing (vue matÃ©rialisÃ©e)</li>
</ul>

<hr>

<h2>ğŸ”„ Delete vs Compaction (RÃ©sumÃ©)</h2>

<table>
    <tr>
        <th>Aspect</th>
        <th>Delete Topic</th>
        <th>Compaction Topic</th>
    </tr>
    <tr>
        <td>CritÃ¨re</td>
        <td>Temps / Taille</td>
        <td>ClÃ©</td>
    </tr>
    <tr>
        <td>Suppression</td>
        <td>Messages anciens</td>
        <td>Anciennes versions</td>
    </tr>
    <tr>
        <td>ClÃ© requise</td>
        <td>Non</td>
        <td>Oui</td>
    </tr>
    <tr>
        <td>Ordre des messages</td>
        <td>Important</td>
        <td>Moins important</td>
    </tr>
    <tr>
        <td>Usage</td>
        <td>Historique</td>
        <td>Ã‰tat courant</td>
    </tr>
</table>

<div class="note">
    âš ï¸ Un topic peut avoir les deux politiques :
    <code>cleanup.policy=delete,compact</code><br>
    Kafka reste <strong>append-only</strong> et le nettoyage est <strong>asynchrone</strong>.
</div>
<p>End.</p>